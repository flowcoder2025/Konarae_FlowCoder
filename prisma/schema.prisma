// Konarae FlowCoder - Government Support Project Matching Platform
// Based on FDP (Flowcoder Development Process) Architecture

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [pgvector(map: "vector")]
}

// ============================================
// NextAuth.js Core Tables
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  image         String?
  emailVerified DateTime?
  role          String    @default("user") // user, admin
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts            Account[]
  sessions            Session[]
  companies           CompanyMember[]
  businessPlans       BusinessPlan[]
  matchingResults     MatchingResult[]
  matchingPreferences MatchingPreference[]
  evaluations         Evaluation[]
  notifications       Notification[]
  notificationSetting NotificationSetting?
  uploadedDocuments   CompanyDocument[]
  credit              Credit?
  gapDiagnoses        GapDiagnosis[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// ReBAC Permission System
// ============================================

model RelationTuple {
  id          String   @id @default(cuid())
  namespace   String // e.g., "company", "business_plan"
  objectId    String // resource ID
  relation    String // e.g., "owner", "editor", "viewer"
  subjectType String // "user" or "group"
  subjectId   String // user or group ID
  createdAt   DateTime @default(now())

  @@unique([namespace, objectId, relation, subjectType, subjectId])
  @@index([namespace, objectId])
  @@index([subjectType, subjectId])
}

model RelationDefinition {
  id        String   @id @default(cuid())
  namespace String
  relation  String
  inherits  String[] // relations this relation inherits from

  @@unique([namespace, relation])
}

// ============================================
// Domain Tables
// ============================================

model Company {
  id                 String   @id @default(cuid())
  name               String
  businessNumber     String   @unique
  corporationNumber  String?
  representativeName String
  establishedDate    DateTime
  companyType        String

  // Business Info
  businessCategory String?
  mainBusiness     String?
  businessItems    String[]

  // Contact
  phone   String
  fax     String?
  email   String
  website String?

  // Address
  zipcode       String?
  address       String
  addressDetail String?

  // Scale
  employeeCount Int?
  capitalAmount BigInt?
  annualRevenue BigInt?
  companySize   String?

  // Certifications
  isVenture  Boolean @default(false)
  isInnoBiz  Boolean @default(false)
  isMainBiz  Boolean @default(false)
  isSocial   Boolean @default(false)
  isWomen    Boolean @default(false)
  isDisabled Boolean @default(false)

  // Content
  introduction String?   @db.Text
  vision       String?
  mission      String?
  coreValues   String[]

  // Media
  logoUrl   String?
  bannerUrl String?

  // Status
  isPublic   Boolean   @default(false)
  isVerified Boolean   @default(false)
  verifiedAt DateTime?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  members             CompanyMember[]
  financials          CompanyFinancial[]
  certifications      CompanyCertification[]
  achievements        CompanyAchievement[]
  matchingResults     MatchingResult[]
  businessPlans       BusinessPlan[]
  matchingPreferences MatchingPreference[]
  documents           CompanyDocument[]
  gapDiagnoses        GapDiagnosis[]

  @@index([businessNumber])
  @@index([name])
}

model CompanyMember {
  id        String    @id @default(cuid())
  companyId String
  userId    String
  role      String // owner, admin, member, viewer
  invitedAt DateTime  @default(now())
  joinedAt  DateTime?

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([companyId, userId])
  @@index([userId])
}

model CompanyFinancial {
  id               String    @id @default(cuid())
  companyId        String
  fiscalYear       Int
  revenue          BigInt?
  operatingProfit  BigInt?
  netProfit        BigInt?
  totalAssets      BigInt?
  totalLiabilities BigInt?
  equity           BigInt?
  creditRating     String?
  ratingAgency     String?
  ratingDate       DateTime?
  notes            String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, fiscalYear])
  @@index([fiscalYear])
}

model CompanyCertification {
  id                  String   @id @default(cuid())
  companyId           String
  certificationType   String
  certificationName   String
  issuingOrganization String
  certificationNumber String?
  issueDate           DateTime
  expiryDate          DateTime?
  fileUrl             String?
  isActive            Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
}

model CompanyAchievement {
  id              String   @id @default(cuid())
  companyId       String
  achievementType String // award, patent, certification, contract, investment
  title           String
  description     String?  @db.Text
  organization    String?
  achievementDate DateTime
  fileUrl         String?
  linkUrl         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
}

// ============================================
// Support Project Tables
// ============================================

model SupportProject {
  id         String  @id @default(cuid())
  externalId String? @unique
  name       String
  organization String
  category String
  subCategory String?
  target String
  region String

  // Amount
  amountMin         BigInt?
  amountMax         BigInt?
  fundingSummary    String?  // 간결한 지원금액 요약 (예: "최대 400만원")
  amountDescription String?  // 상세 지원금액 설명

  // Timeline
  startDate   DateTime?
  endDate     DateTime?
  deadline    DateTime?
  isPermanent Boolean   @default(false)

  // Content
  summary            String    @db.Text
  description        String?   @db.Text
  eligibility        String?   @db.Text
  applicationProcess String?   @db.Text
  evaluationCriteria String?   @db.Text
  requiredDocuments  String[]
  contactInfo        String?
  websiteUrl         String?

  // Files
  detailUrl        String?
  attachmentUrls   String[]
  originalFileUrl  String?
  originalFileType String? // hwp, hwpx, pdf

  // Status
  status        String   @default("active") // draft, active, closed
  viewCount     Int      @default(0)
  bookmarkCount Int      @default(0)

  // Metadata
  crawledAt DateTime?
  sourceUrl String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Embedding queue flag
  needsEmbedding Boolean @default(true) // Flag for async embedding generation

  matchingResults MatchingResult[]
  businessPlans   BusinessPlan[]
  attachments     ProjectAttachment[]
  gapDiagnoses    GapDiagnosis[]

  @@index([category])
  @@index([region])
  @@index([status])
  @@index([deadline])
}

model ProjectAttachment {
  id          String  @id @default(cuid())
  projectId   String
  fileName    String  // 원본 파일명 (Content-Disposition에서 추출)
  fileType    String  // hwp, hwpx, pdf, unknown
  fileSize    Int     // 바이트 단위 (0 = 크기 미확인)
  storagePath String? // Supabase 버킷 내 경로 (핵심 문서만 저장)
  sourceUrl   String  // 원본 다운로드 URL (필수)

  // 스마트 파싱
  shouldParse   Boolean @default(false) // 파싱 대상 여부
  isParsed      Boolean @default(false) // 파싱 완료 여부
  parsedContent String? @db.Text        // 파싱된 텍스트 내용
  parseError    String?                 // 파싱 실패 시 에러 메시지

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project SupportProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([fileType])
  @@index([shouldParse, isParsed])
}

model CrawlJob {
  id              String    @id @default(cuid())
  sourceId        String
  status          String    @default("pending") // pending, running, completed, failed
  startedAt       DateTime?
  completedAt     DateTime?
  errorMessage    String?
  projectsFound   Int       @default(0)
  projectsNew     Int       @default(0)
  projectsUpdated Int       @default(0)

  createdAt DateTime @default(now())

  source CrawlSource @relation(fields: [sourceId], references: [id])

  @@index([status])
  @@index([createdAt(sort: Desc)])
}

model CrawlSource {
  id          String    @id @default(cuid())
  name        String
  url         String    @unique
  type        String // api, web
  schedule    String? // cron expression
  isActive    Boolean   @default(true)
  lastCrawled DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  jobs CrawlJob[]

  @@index([isActive])
}

// ============================================
// Matching Tables
// ============================================

model MatchingResult {
  id        String @id @default(cuid())
  userId    String
  companyId String
  projectId String

  // Scores
  totalScore             Int
  businessSimilarityScore Int    @default(0) // 사업 유사도 (텍스트 + 문서 벡터 통합)
  categoryScore          Int
  eligibilityScore       Int
  timelinessScore        Int
  amountScore            Int

  // Details
  confidence   String // high, medium, low
  matchReasons String[]

  // User Feedback
  isRelevant   Boolean?
  feedbackNote String?

  createdAt DateTime @default(now())

  user    User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  project SupportProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([companyId, projectId])
  @@index([userId])
  @@index([totalScore(sort: Desc)])
}

model MatchingPreference {
  id        String @id @default(cuid())
  userId    String
  companyId String

  categories      String[]
  minAmount       BigInt?
  maxAmount       BigInt?
  regions         String[]
  excludeKeywords String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId])
}

// ============================================
// Business Plan Tables
// ============================================

model BusinessPlan {
  id        String  @id @default(cuid())
  userId    String
  companyId String
  projectId String?

  title      String
  status     String  @default("draft") // draft, in_progress, completed, submitted
  templateId String?

  // Additional Context
  newBusinessDescription String? @db.Text
  additionalNotes        String? @db.Text

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  user    User            @relation(fields: [userId], references: [id])
  company Company         @relation(fields: [companyId], references: [id])
  project SupportProject? @relation(fields: [projectId], references: [id])

  sections    BusinessPlanSection[]
  evaluations Evaluation[]
  attachments BusinessPlanAttachment[]

  // Self-referencing for reference plans
  referencedBy BusinessPlanReference[] @relation("ReferencePlan")
  references   BusinessPlanReference[] @relation("SourcePlan")

  @@index([userId])
  @@index([companyId])
  @@index([status])
}

model BusinessPlanAttachment {
  id             String @id @default(cuid())
  businessPlanId String

  fileName    String
  fileType    String // "application/pdf", "image/png", "image/jpeg"
  fileUrl     String // Supabase Storage URL
  fileSize    Int
  description String? @db.Text

  // AI Analysis
  extractedText String?  @db.Text
  isAnalyzed    Boolean  @default(false)

  createdAt DateTime @default(now())

  businessPlan BusinessPlan @relation(fields: [businessPlanId], references: [id], onDelete: Cascade)

  @@index([businessPlanId])
}

model BusinessPlanReference {
  id             String @id @default(cuid())
  businessPlanId String // The plan being created
  referencePlanId String // The plan being referenced

  createdAt DateTime @default(now())

  businessPlan  BusinessPlan @relation("SourcePlan", fields: [businessPlanId], references: [id], onDelete: Cascade)
  referencePlan BusinessPlan @relation("ReferencePlan", fields: [referencePlanId], references: [id], onDelete: Cascade)

  @@unique([businessPlanId, referencePlanId])
  @@index([businessPlanId])
  @@index([referencePlanId])
}

model BusinessPlanSection {
  id             String  @id @default(cuid())
  businessPlanId String

  sectionIndex  Int
  title         String
  content       String  @db.Text
  isAiGenerated Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  businessPlan BusinessPlan @relation(fields: [businessPlanId], references: [id], onDelete: Cascade)

  @@unique([businessPlanId, sectionIndex])
}

// ============================================
// Evaluation Tables
// ============================================

model Evaluation {
  id              String  @id @default(cuid())
  userId          String
  businessPlanId  String?
  uploadedFileUrl String?
  criteria        String? @db.Text // Evaluation criteria

  // Overall
  totalScore Int?
  summary    String? @db.Text

  // Status
  status       String  @default("pending") // pending, processing, completed, failed
  errorMessage String?

  createdAt   DateTime  @default(now())
  completedAt DateTime?

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  businessPlan BusinessPlan? @relation(fields: [businessPlanId], references: [id])

  feedbacks EvaluationFeedback[]

  @@index([userId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
}

model EvaluationFeedback {
  id           String @id @default(cuid())
  evaluationId String

  criteriaName String
  score        Int?
  maxScore     Int?
  feedback     String?  @db.Text
  strengths    String[]
  weaknesses   String[]
  suggestions  String[]

  createdAt DateTime @default(now())

  evaluation Evaluation @relation(fields: [evaluationId], references: [id], onDelete: Cascade)

  @@index([evaluationId])
}

// ============================================
// Notification Tables
// ============================================

model Notification {
  id      String  @id @default(cuid())
  userId  String
  type    String // deadline_alert, matching_result, evaluation_complete
  title   String
  message String
  data    Json?
  isRead  Boolean @default(false)

  createdAt DateTime  @default(now())
  readAt    DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
}

model NotificationSetting {
  id     String @id @default(cuid())
  userId String @unique

  // Channels
  emailEnabled   Boolean @default(true)
  discordEnabled Boolean @default(false)
  slackEnabled   Boolean @default(false)

  // Webhooks
  discordWebhookUrl String?
  slackWebhookUrl   String?

  // Types
  deadlineAlertDays         Int     @default(7)
  matchingResultEnabled     Boolean @default(true)
  evaluationCompleteEnabled Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============================================
// Company Document Management
// ============================================

model CompanyDocument {
  id        String @id @default(cuid())
  companyId String

  // 문서 유형 (10가지)
  documentType String
  // business_registration, corporation_registry, sme_certificate,
  // financial_statement, employment_insurance, export_performance,
  // certification, company_introduction, business_plan, patent

  // 파일 정보 (PDF/이미지만)
  fileName String
  fileSize Int
  mimeType String
  fileUrl  String

  // 메타데이터
  uploadedBy String
  version    Int    @default(1)

  // 상태
  status       String  @default("uploaded") // uploaded, analyzing, analyzed, failed
  errorMessage String?

  // 타임스탬프
  uploadedAt DateTime  @default(now())
  analyzedAt DateTime?
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?

  company    Company                   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  uploader   User                      @relation(fields: [uploadedBy], references: [id])
  analysis   CompanyDocumentAnalysis?
  embeddings CompanyDocumentEmbedding[]

  @@index([companyId, documentType])
  @@index([status])
  @@index([uploadedBy])
}

model CompanyDocumentAnalysis {
  id         String @id @default(cuid())
  documentId String @unique

  // AI 분석 결과
  extractedData   Json
  summary         String   @db.Text
  keyInsights     String[]
  confidenceScore Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  document CompanyDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
}

model CompanyDocumentEmbedding {
  id         String                      @id @default(cuid())
  documentId String
  chunkIndex Int
  content    String                      @db.Text
  embedding  Unsupported("vector(1536)")
  metadata   Json                        @default("{}")

  createdAt DateTime @default(now())

  document CompanyDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, chunkIndex])
  @@index([documentId])
}

// ============================================
// RAG Unified Embeddings Table (PRD 12)
// ============================================

/// document_embeddings - 통합 RAG 임베딩 테이블
/// support_project, company, business_plan 등의 벡터 임베딩 저장
model DocumentEmbedding {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // Polymorphic reference
  sourceType String @map("source_type") @db.VarChar(50) // 'support_project' | 'company' | 'business_plan'
  sourceId   String @map("source_id")

  // Content
  content       String @db.Text
  chunkIndex    Int    @map("chunk_index")
  chunkMetadata Json?  @default("{}") @map("chunk_metadata")

  // Vector (1536 for OpenAI text-embedding-3-small)
  embedding Unsupported("vector(1536)")

  // Search optimization - BM25 keyword search
  keywords String[]

  // Timestamps
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([sourceType, sourceId, chunkIndex])
  @@index([sourceType, sourceId], map: "idx_embeddings_source")
  @@index([createdAt(sort: Desc)], map: "idx_embeddings_created")
  @@index([embedding], map: "idx_embeddings_hnsw")
  @@index([keywords], map: "idx_embeddings_keywords", type: Gin)
  @@map("document_embeddings")
}

// ============================================
// Credit System (크래딧 과금)
// ============================================

/// 사용자 크래딧 잔액
model Credit {
  id             String   @id @default(cuid())
  userId         String   @unique
  balance        Int      @default(100) // 신규 가입 시 100C 무료 지급
  totalPurchased Int      @default(0)   // 누적 구매 금액
  totalUsed      Int      @default(0)   // 누적 사용량
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions CreditTransaction[]

  @@map("credits")
}

/// 크래딧 거래 내역
model CreditTransaction {
  id           String   @id @default(cuid())
  creditId     String
  type         String   // 'signup_bonus' | 'purchase' | 'usage' | 'refund'
  amount       Int      // +100 (충전), -15 (사용)
  balanceAfter Int      // 거래 후 잔액
  description  String   // "부족항목 진단 - 2024 스마트공장 지원사업"
  relatedType  String?  // 'diagnosis' | 'check' | 'generation'
  relatedId    String?  // GapDiagnosis.id 등
  createdAt    DateTime @default(now())

  credit Credit @relation(fields: [creditId], references: [id], onDelete: Cascade)

  @@index([creditId])
  @@index([createdAt(sort: Desc)])
  @@map("credit_transactions")
}

// ============================================
// Gap Diagnosis System (부족항목 진단)
// ============================================

/// 부족항목 진단 결과
model GapDiagnosis {
  id        String @id @default(cuid())
  companyId String
  projectId String
  userId    String // 요청자

  // 진단 결과
  fitScore Int?   // 0-100 적합도 점수
  status   String @default("pending")
  // pending | processing | completed | failed

  // JSON 필드 (상세 결과)
  requirements Json? // ExtractedRequirement[] - 추출된 요구사항
  gaps         Json? // GapItem[] - 부족 항목 목록
  actions      Json? // ActionItem[] - 개선 액션 목록

  // 메타
  creditUsed   Int     @default(15)
  errorMessage String?

  createdAt   DateTime  @default(now())
  completedAt DateTime?

  company Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  project SupportProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([projectId])
  @@index([userId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("gap_diagnoses")
}
