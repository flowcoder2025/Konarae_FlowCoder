# 매칭 로직 개선 v3

> 작성일: 2025-12-26
> 상태: 진행 중

## 배경

### 발견된 문제

1. **지역 불일치율 68.1%**
   - 대구 기업에게 부산, 서울, 경남, 전남 등 타 지역 사업 매칭
   - 매칭 결과 188건 중 128건 불일치

2. **지역 추출 버그**
   - "경상북도 고령군" → "전국"으로 추출 (경북으로 추출되어야 함)
   - 풀네임 지역 매핑 누락

3. **매칭 로직 구조 문제**
   - `preferences.regions`가 명시적으로 전달되어야만 필터링
   - 기업 주소에서 자동 지역 추출 후 필터링 로직 없음

### 현재 매칭 가중치 (v2)

| 요소 | 가중치 | 설명 |
|-----|--------|------|
| businessSimilarity | 50% | RAG 텍스트 + 문서 벡터 유사도 |
| category | 25% | 업종 적합도 |
| eligibility | 25% | 자격 요건 |

**문제**: 지역은 점수에 반영되지 않고, 필터링만 가능

---

## 개선 계획

### 1단계: 지역 추출 함수 개선

**Before:**
```typescript
const regionMap = { "서울": "서울", "대구": "대구", ... }
```

**After:**
```typescript
const regionMap = {
  "서울특별시": "서울", "서울시": "서울", "서울": "서울",
  "경상북도": "경북", "경북": "경북",
  "경상남도": "경남", "경남": "경남",
  // ... 모든 지역 풀네임/약어 매핑
}
```

### 2단계: 매칭 로직에 지역 자동 필터링 추가

**개선 방향:**
1. 기업 주소에서 지역 자동 추출
2. 지역 기반 프로젝트 필터링:
   - "전국" 사업: 항상 포함
   - 지역별 사업: 기업 지역 일치 시만 포함
3. 지역 점수 도입 (선택적)

### 3단계: 매칭 결과 품질 검증

- 개선 전/후 비교 스크립트 실행
- 지역 일치율 목표: 95% 이상

---

## 구현 상세

### 변경 파일

1. `/src/lib/matching.ts` - 지역 추출 및 필터링 로직
2. `/src/lib/region.ts` (신규) - 지역 유틸리티 함수

### 테스트 계획

1. 단위 테스트: 지역 추출 함수
2. 통합 테스트: 매칭 결과 지역 일치율

---

## 진행 상황

- [x] 문제 분석 완료 (2025-12-26)
- [x] DB 데이터 검증 완료
- [x] 지역 추출 함수 개선 (`/src/lib/region.ts` 신규 생성)
- [x] 매칭 로직 수정 (`/src/lib/matching.ts` v3 적용)
- [x] 테스트 및 검증 (13/13 추출, 14/14 매칭 통과)
- [x] 전체 기업 매칭 재실행 (5/5 성공)
- [x] Unique constraint 오류 수정 (`storeMatchingResults` 함수)
- [x] 문서 최종 업데이트 (2025-12-27)

## 구현 결과

### 신규 파일
- `/src/lib/region.ts`: 지역 유틸리티 함수
  - `extractRegionFromAddress()`: 주소에서 지역 코드 추출
  - `isRegionMatch()`: 기업-프로젝트 지역 매칭 여부 확인
  - `normalizeRegion()`: 지역명 정규화

### 수정된 파일
- `/src/lib/matching.ts`:
  - 기업 주소에서 지역 자동 추출 (line 607)
  - 지역 자동 필터링 로직 추가 (line 667-678)
  - 프로젝트 조회 시 `region` 필드 추가

### 테스트 결과
```
대구 기업: 626개 → 355개 매칭 가능 (271개 필터링)
경북 기업: 626개 → 377개 매칭 가능 (249개 필터링)
```

### 전체 기업 매칭 재실행 결과 (2025-12-27)
| 기업명 | 지역 | 매칭 결과 | 지역 필터링 | 상태 |
|-------|------|----------|------------|------|
| FlowCoder | 없음 | 200개 | 필터링 안함 | ✅ 성공 |
| 주식회사 엠엔티 | 대구 | 69개 | 200→69 | ✅ 성공 |
| 주식회사 딕슨 | 대구 | 69개 | 200→69 | ✅ 성공 |
| 주식회사 테크트리아이엔씨 | 대구 | 69개 | 200→69 | ✅ 성공 |
| (주)대영하이텍 | 경북 | 77개 | 200→77 | ✅ 성공 |

**지역 불일치율**: 68.1% → 0% ✅

### 필터링 규칙
1. "전국" 사업: 항상 포함
2. 기업 지역과 일치하는 지역 사업만 포함
3. 기업 주소에서 지역 추출 불가 시: 모든 사업 포함 (필터링 안함)
4. `preferences.regions` 명시 시: 해당 지역만 필터링

---

## 참고: 지역 분포 현황

```
전국: 348개 (55.6%)
인천: 30개
경북: 29개
울산: 27개
제주: 25개
경기: 23개
강원: 21개
충남: 18개
충북: 17개
전남: 15개
서울: 15개
전북특별자치도: 13개
경남: 12개
대전: 9개
광주: 9개
대구: 7개
세종: 4개
부산: 4개
```
